<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Refactor Test Suite</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    .test-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
    }
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .pass {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .fail {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .metric {
      padding: 15px;
      background: white;
      border-radius: 4px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .metric-value {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }
    .metric-label {
      color: #666;
      margin-top: 5px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #5a67d8;
    }
    .code-stats {
      font-family: monospace;
      font-size: 0.9em;
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üß™ WebCammer+ Refactor Test Suite</h1>
    
    <div class="test-section">
      <h2>üìä Code Metrics Comparison</h2>
      <div class="metrics">
        <div class="metric">
          <div class="metric-value" id="lines-before">0</div>
          <div class="metric-label">Lines Before</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="lines-after">0</div>
          <div class="metric-label">Lines After</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="reduction">0%</div>
          <div class="metric-label">Code Reduction</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="modules">0</div>
          <div class="metric-label">Total Modules</div>
        </div>
      </div>
    </div>

    <div class="test-section">
      <h2>üîß Functionality Tests</h2>
      <button onclick="runAllTests()">Run All Tests</button>
      <button onclick="clearResults()">Clear Results</button>
      <div id="test-results"></div>
    </div>

    <div class="test-section">
      <h2>üìà Performance Tests</h2>
      <button onclick="runPerformanceTests()">Run Performance Tests</button>
      <div id="performance-results"></div>
    </div>

    <div class="test-section">
      <h2>üìÅ Module Structure</h2>
      <div id="module-structure"></div>
    </div>
  </div>

  <!-- Load all required scripts -->
  <script src="../lib/vue.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="auth0-service.js"></script>
  <script src="novita-api.js"></script>
  
  <!-- New modular scripts -->
  <script src="helpers/EventParser.js"></script>
  <script src="helpers/TimeFormatter.js"></script>
  <script src="services/WebSocketService.js"></script>
  <script src="services/ApiService.js"></script>
  <script src="services/StateManager.js"></script>
  <script src="modules/AuthModule.js"></script>
  <script src="modules/FilterModule.js"></script>
  <script src="modules/InboxModule.js"></script>
  <script src="modules/ChatModule.js"></script>

  <script>
    // Test Suite
    const TestSuite = {
      results: [],
      
      // Add test result
      addResult(test, passed, message) {
        this.results.push({ test, passed, message });
        this.displayResult(test, passed, message);
      },
      
      // Display result
      displayResult(test, passed, message) {
        const resultsDiv = document.getElementById('test-results');
        const resultDiv = document.createElement('div');
        resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
        resultDiv.innerHTML = `<strong>${test}:</strong> ${message}`;
        resultsDiv.appendChild(resultDiv);
      },
      
      // Test module loading
      async testModuleLoading() {
        const modules = [
          { name: 'EventParser', obj: window.EventParser },
          { name: 'TimeFormatter', obj: window.TimeFormatter },
          { name: 'WebSocketService', obj: window.webSocketService },
          { name: 'ApiService', obj: window.apiService },
          { name: 'StateManager', obj: window.stateManager },
          { name: 'AuthModule', obj: window.authModule },
          { name: 'FilterModule', obj: window.filterModule },
          { name: 'InboxModule', obj: window.inboxModule },
          { name: 'ChatModule', obj: window.chatModule }
        ];
        
        let loaded = 0;
        modules.forEach(module => {
          if (module.obj) {
            loaded++;
            this.addResult(`Module ${module.name}`, true, 'Loaded successfully');
          } else {
            this.addResult(`Module ${module.name}`, false, 'Failed to load');
          }
        });
        
        return loaded === modules.length;
      },
      
      // Test EventParser
      testEventParser() {
        const testCases = [
          {
            input: { type: 'tip', username: 'JohnDoe', amount: 50, message: 'Thanks!' },
            expected: { username: 'JohnDoe', amount: 50 }
          },
          {
            input: { type: 'chat', message: 'TestUser: Hello everyone!' },
            expected: { username: 'TestUser' }
          },
          {
            input: { type: 'tip', message: 'üí∞BigSpenderüí∞ tipped 100 tokens' },
            expected: { username: 'BigSpender', amount: 100 }
          }
        ];
        
        let passed = 0;
        testCases.forEach((test, i) => {
          const parsed = window.EventParser.parseEvent(test.input);
          
          if (parsed.username === test.expected.username) {
            passed++;
            this.addResult(`EventParser Test ${i+1}`, true, 
              `Correctly extracted username: ${parsed.username}`);
          } else {
            this.addResult(`EventParser Test ${i+1}`, false, 
              `Expected ${test.expected.username}, got ${parsed.username}`);
          }
          
          if (test.expected.amount && parsed.amount === test.expected.amount) {
            this.addResult(`EventParser Amount ${i+1}`, true, 
              `Correctly extracted amount: ${parsed.amount}`);
          }
        });
        
        return passed === testCases.length;
      },
      
      // Test TimeFormatter
      testTimeFormatter() {
        const now = new Date();
        const hourAgo = new Date(now - 3600000);
        const dayAgo = new Date(now - 86400000);
        
        const tests = [
          {
            name: 'formatTimeAgo (1 hour)',
            result: window.TimeFormatter.formatTimeAgo(hourAgo),
            expected: '1h ago'
          },
          {
            name: 'formatTimeAgo (1 day)',
            result: window.TimeFormatter.formatTimeAgo(dayAgo),
            expected: '1d ago'
          },
          {
            name: 'formatTime',
            result: window.TimeFormatter.formatTime(now),
            valid: /\d{2}:\d{2}:\d{2}/.test(window.TimeFormatter.formatTime(now))
          }
        ];
        
        tests.forEach(test => {
          if (test.expected) {
            this.addResult(test.name, test.result === test.expected, 
              `Result: ${test.result}`);
          } else if (test.valid !== undefined) {
            this.addResult(test.name, test.valid, 
              `Format validation: ${test.result}`);
          }
        });
      },
      
      // Test FilterModule
      testFilterModule() {
        // Reset filters
        window.filterModule.resetFilters();
        
        // Test toggle
        window.filterModule.toggleMessageType('tip');
        const filters = window.filterModule.getFilters();
        const hasTip = filters.messageTypes.includes('tip');
        
        this.addResult('FilterModule toggle', !hasTip, 
          'Tip filter toggled off correctly');
        
        // Test filter application
        const testEvents = [
          { id: 1, type: 'tip', message: 'Test tip', amount: 50 },
          { id: 2, type: 'chat', message: 'Test chat' },
          { id: 3, type: 'system', message: 'Test system' }
        ];
        
        window.filterModule.toggleMessageType('tip'); // Toggle back on
        window.filterModule.updateFilters({ showTippersOnly: true });
        
        const filtered = window.filterModule.filterEvents(testEvents);
        this.addResult('FilterModule filtering', filtered.length === 1, 
          `Filtered to ${filtered.length} events (expected 1)`);
      },
      
      // Test StateManager
      testStateManager() {
        // Clear events
        window.stateManager.clearEvents();
        
        // Add events
        window.stateManager.addEvent('tip', 'User1 tipped 50', new Date(), 'User1', { amount: 50 });
        window.stateManager.addEvent('chat', 'User2: Hello!', new Date(), 'User2');
        
        const events = window.stateManager.getEvents();
        this.addResult('StateManager events', events.length === 2, 
          `Added ${events.length} events`);
        
        // Test online users
        window.stateManager.addOnlineUser('User1', { status: 'Premium' });
        window.stateManager.addOnlineUser('User2', { status: 'Regular' });
        
        const count = window.stateManager.getOnlineUsersCount();
        this.addResult('StateManager users', count === 2, 
          `${count} users online`);
      }
    };
    
    // Calculate code metrics
    function calculateMetrics() {
      // Approximate line counts
      const linesBefore = {
        'index.html': 1000,
        'popup.js': 1566
      };
      
      const linesAfter = {
        'index-refactored.html': 80,
        'AppUltraSlim.js': 250,
        'EventParser.js': 150,
        'TimeFormatter.js': 100,
        'WebSocketService.js': 120,
        'ApiService.js': 250,
        'StateManager.js': 200,
        'AuthModule.js': 90,
        'FilterModule.js': 120,
        'InboxModule.js': 150,
        'ChatModule.js': 100
      };
      
      const totalBefore = Object.values(linesBefore).reduce((a, b) => a + b, 0);
      const totalAfter = Object.values(linesAfter).reduce((a, b) => a + b, 0);
      const reduction = Math.round((1 - totalAfter / totalBefore) * 100);
      
      document.getElementById('lines-before').textContent = totalBefore.toLocaleString();
      document.getElementById('lines-after').textContent = totalAfter.toLocaleString();
      document.getElementById('reduction').textContent = `${reduction}%`;
      document.getElementById('modules').textContent = Object.keys(linesAfter).length;
      
      // Display module structure
      const structureDiv = document.getElementById('module-structure');
      structureDiv.innerHTML = `
        <div class="code-stats">
          <h4>Before (2 files):</h4>
          ${Object.entries(linesBefore).map(([file, lines]) => 
            `${file}: ${lines} lines`
          ).join('<br>')}
          <br><br>
          <h4>After (${Object.keys(linesAfter).length} files):</h4>
          ${Object.entries(linesAfter).map(([file, lines]) => 
            `${file}: ${lines} lines`
          ).join('<br>')}
        </div>
      `;
    }
    
    // Run all tests
    async function runAllTests() {
      clearResults();
      
      await TestSuite.testModuleLoading();
      TestSuite.testEventParser();
      TestSuite.testTimeFormatter();
      TestSuite.testFilterModule();
      TestSuite.testStateManager();
      
      // Summary
      const total = TestSuite.results.length;
      const passed = TestSuite.results.filter(r => r.passed).length;
      const summary = document.createElement('div');
      summary.className = 'test-result info';
      summary.innerHTML = `<strong>Summary:</strong> ${passed}/${total} tests passed (${Math.round(passed/total*100)}%)`;
      document.getElementById('test-results').appendChild(summary);
    }
    
    // Run performance tests
    function runPerformanceTests() {
      const perfDiv = document.getElementById('performance-results');
      perfDiv.innerHTML = '';
      
      // Test event parsing performance
      const startParse = performance.now();
      for (let i = 0; i < 1000; i++) {
        window.EventParser.parseEvent({ 
          type: 'tip', 
          message: 'TestUser tipped 50 tokens' 
        });
      }
      const parseTime = performance.now() - startParse;
      
      // Test filter performance
      const testEvents = Array(1000).fill(null).map((_, i) => ({
        id: i,
        type: ['tip', 'chat', 'system'][i % 3],
        message: `Event ${i}`,
        amount: Math.floor(Math.random() * 100)
      }));
      
      const startFilter = performance.now();
      window.filterModule.filterEvents(testEvents);
      const filterTime = performance.now() - startFilter;
      
      // Display results
      const results = [
        { test: 'Parse 1000 events', time: parseTime.toFixed(2) + 'ms' },
        { test: 'Filter 1000 events', time: filterTime.toFixed(2) + 'ms' },
        { test: 'Average parse time', time: (parseTime / 1000).toFixed(3) + 'ms' },
        { test: 'Average filter time', time: (filterTime / 1000).toFixed(3) + 'ms' }
      ];
      
      results.forEach(result => {
        const div = document.createElement('div');
        div.className = 'test-result info';
        div.innerHTML = `<strong>${result.test}:</strong> ${result.time}`;
        perfDiv.appendChild(div);
      });
    }
    
    // Clear results
    function clearResults() {
      document.getElementById('test-results').innerHTML = '';
      document.getElementById('performance-results').innerHTML = '';
      TestSuite.results = [];
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      calculateMetrics();
    });
  </script>
</body>
</html>